#!/bin/bash

# ----------
# Script de NiPeGun para aplicar ataque de fuerza bruta a archivo .zip protegido por contraseña
#
# Ejecución remota (puede requerir permisos sudo):
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/Hashes/john-FuerzaBruta-Archivo-zip.sh | bash -s [RutaAlArchivoZIP] [CantCaracteresASCIIaProbar]
#
# Ejecución remota como root (para sistemas sin sudo):
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/Hashes/john-FuerzaBruta-Archivo-zip.sh | sed 's-sudo--g' | bash -s [RutaAlArchivoZIP] [CantCaracteresASCIIaProbar]
#
# Bajar y editar directamente el archivo en nano
#   curl -sL https://raw.githubusercontent.com/nipegun/pt-scripts/refs/heads/main/2-Exploit/Hashes/john-FuerzaBruta-Archivo-zip.sh | nano -
# ----------

# Definir constantes de color
  cColorAzul='\033[0;34m'
  cColorAzulClaro='\033[1;34m'
  cColorVerde='\033[1;32m'
  cColorRojo='\033[1;31m'
  # Para el color rojo también:
    #echo "$(tput setaf 1)Mensaje en color rojo. $(tput sgr 0)"
  cFinColor='\033[0m'

# Comprobar que se hayan pasado la cantidad de parámetros correctos. Abortar el script si no.
  cCantParamEsperados=2
  if [ $# -ne $cCantParamEsperados ]
    then
      echo ""
      echo -e "${cColorRojo}  Mal uso del script. El uso correcto sería: ${cFinColor}"
      echo "    $0 [RutaAlArchivoZIP] [CantCaracteresASCIIaProbar]"
      echo ""
      echo "  Ejemplo:"
      echo "    $0 '$HOME/Descargas/ArchivoProtegido.zip' 8"
      echo ""
      exit
  fi

# Comprobar que el archivo pasado exista
  if [ ! -f "$1" ]; then
    echo "  El archivo $1 no existe!"
    exit 1
  fi

# Comprobar si el segundo parámetro es un número entero
  if ! [[ "$2" =~ ^[0-9]+$ ]]; then
    echo "    El segundo parámetro debe ser un número entero (longitud de la máscara)."
    exit 1
  fi

vRutaAlArchivo="$1"
vCantCaracteresASCIIaProbar="$2"

# Extraer el hash de la contraseña del archivo
  echo ""
  echo "  Intentando extraer el hash de la contraseña del archivo..."
  echo ""
  # Comprobar si zip2john está disponible, si no lo está, compilarlo e instalarlo
    if [ ! -f "$HOME/HackingTools/john/zip2john" ]; then
      echo ""
      echo -e "${cColorRojo}    zip2john no está instalado. Iniciando su instalación...${cFinColor}"
      echo ""
      sudo apt -y update
      sudo apt -y install curl
      curl -sL https://raw.githubusercontent.com/nipegun/dh-scripts/refs/heads/main/Recursos/Software/ParaCLI/zip2john-Instalar-Compilando.sh | bash
    fi
  $HOME/HackingTools/john/zip2john "$vRutaAlArchivo" > "$vRutaAlArchivo.hashes"
  # Comprobar que el hash se haya extraido
    if [ ! -s "$vRutaAlArchivo.hashes" ]; then
      echo "  No se pudo extraer ningún hash del archivo ZIP."
      exit 1
    fi
  echo ""

# Crackear contraseña
  echo ""
  echo "  Intentando crackear contraseña..."
  echo ""
  # Generar máscara ASCII con la longitud indicada
    # Preguntar tipo de máscara
      echo ""
      echo "  Selecciona el tipo de caracteres a usar:"
      echo "    1) ?a  Cualquier carácter ASCII imprimible"
      echo "    2) ?l  Solo minúsculas"
      echo "    3) ?u  Solo mayúsculas"
      echo "    4) ?d  Solo números"
      echo "    5) ?s  Solo símbolos"
      echo ""
      read -p "  Opción: " vOpcionMascara < /dev/tty
      case "$vOpcionMascara" in
        1) vTipoMascara="?a" ;;
        2) vTipoMascara="?l" ;;
        3) vTipoMascara="?u" ;;
        4) vTipoMascara="?d" ;;
        5) vTipoMascara="?s" ;;
        *)
          echo "  Opción inválida."
          exit 1
        ;;
      esac
    vMascara=""
    for ((i=0; i<"$vCantCaracteresASCIIaProbar"; i++)); do
      vMascara="${vMascara}${vTipoMascara}"
    done
  $HOME/HackingTools/john/john --internal-codepage=ASCII --mask="$vMascara" "$vRutaAlArchivo.hashes"
  echo ""
# Mostrar contrseña crackeada
  $HOME/HackingTools/john/john --show "$vRutaAlArchivo.hashes" | cut -d':' -f1,2 | sed 's-:- > El password es -g'
  echo ""

